/*
 * FancySelector v1.0 min beta
 * By Rob Garrison (aka Mottie & Fudgey)
 * Dual licensed under the MIT and GPL licenses.
 *
 */

(function(d){d.fancySelector=function(e,f){var a=this;a.el=e;a.$el=d(e).addClass("fancyselectorselect");a.$options=a.$el.find("option");a.$returnedOptions=d.fancySelector.returnedOptions;a.originalSize=a.$el.attr("size");a.originalMultiple=a.$el.attr("multiple");a.$el.data("FancySelector",a);a.init=function(){var c,b;a.options=d.extend({},d.fancySelector.defaultOptions,f);a.selectedOptions="";a.$viewport=a.$el.wrap('<div class="fancyselectorwrapper" />').parent();a.$box=d('<div class="fancyselector"></div>').attr("role", "listbox").css("top",-a.vpHeight);a.$options.each(function(g){c=a.el.options[g].selected?a.options.selected:"";c+=d(this).is(":disabled")?' disabled" aria-disabled="true" disabled="true"':'"';b=d('<div class="'+c+' unselectable="on" role="option"></div>');b.attr("data-value",d(this).val());b.html(d(this).html());a.$box.append(b)});a.$el.attr({size:a.options.page+1,"aria-hidden":!0}).after(a.$box);if(a.options.max===1)a.options.multiple=!1;a.options.multiple?a.$el.attr("multiple","multiple"):a.$el.removeAttr("multiple"); a.$divs=a.$box.find("div");a.listLength=a.$divs.length-1;b=a.options.start;d.fn.isPrototypeOf(b)&&(b=a.$options.index(b));typeof b==="string"&&(b=a.$divs.filter(":contains("+b+")")||a.$divs.filter("[data-value="+b+"]")||0);a.index=d.fn.isPrototypeOf(b)?a.$divs.index(b):b;a.highlight(!0);a.$divs.click(function(b){if(b.shiftKey){a.setSelection();var c;c=a.index;var e=a.$divs.index(d(this)),b=Math.abs(e-c),e=e>c?1:-1;for(c=0;c<b;c++)a.index+=e,a.setSelection();a.highlight()}else a.index=a.$divs.index(d(this)), a.$el.focus(),a.highlight(),b.ctrlKey&&a.setSelection()});d.isFunction(d.fn.mousewheel)&&a.$viewport.bind("mousewheel.fancyselector",function(b,c){a.$box.is(".focused")&&(a.index-=Math.floor(Math.min(Math.abs(c),a.options.page))*(c>0?1:-1),a.checkLimits())});a.$el.add(a.$box).bind("keydown.fancyselector",function(c){a.$box.addClass("focused");a.checkKey(c)}).bind("focus.fancyselector",function(){clearTimeout(a.blurTimer);a.timerFocus=setTimeout(function(){a.$box.is(".focused")||(a.$box.addClass("focused"), a.$el.trigger("focused.fancyselector",a))},200)}).bind("blur.fancyselector",function(){clearTimeout(a.focusTimer);a.blurTimer=setTimeout(function(){a.$box.removeClass("focused");a.getSelections(null,!1);a.$el.trigger("blurred.fancyselector",a)},200)}).bind("focused.fancyselector",function(){a.options.expand&&(c=a.$viewport.height(),b=c*a.options.page,a.$viewport.wrap('<div class="fancyselectorexpanded" />').css({position:"absolute",height:b,top:0}).parent().css({height:b,top:-b/2+c/2}),a.highlight())}).bind("blurred.fancyselector", function(){if(a.options.keepInView&&!a.options.multiple)a.index=a.el.selectedIndex,a.highlight(!0);a.options.expand&&(a.$viewport.removeAttr("style").unwrap(),a.highlight(!0))});d.each("initialized.fancyselector changed.fancyselector submitted.fancyselector focused.fancyselector blurred.fancyselector".split(" "),function(c,b){var e=b.split(".")[0];d.isFunction(a.options[e])&&a.$el.bind(b,a.options[e])});a.options.resizable&&d(window).resize(a.highlight);a.initialized=!0;a.$el.trigger("initialized.fancyselector", a)};a.checkKey=function(c){var b=c.which;switch(b){case 13:return a.getSelections(null,!0);case 32:return c.shiftKey?a.$divs.not(".disabled").filter("."+a.options.selected).length>0?a.unselectAll():a.selectAll():a.setSelection();case 33:case 34:a.index+=(b===33?-1:1)*a.options.page;break;case 39:case 40:c.shiftKey?(c=a.$divs.eq(a.index).is("."+a.options.selected)?!0:!1,a.setSelection(a.index++,c),a.checkLimits(),a.setSelection(a.index,c)):a.index++;break;case 35:case 36:a.index=b===35?a.listLength: 0;break;case 37:case 38:c.shiftKey?(c=a.$divs.eq(a.index).is("."+a.options.selected)?!0:!1,a.setSelection(a.index--,c),a.checkLimits(),a.setSelection(a.index,c)):a.index--;break;case 45:case 46:a.setSelection(a.index,b===45?!0:!1)}a.checkLimits()};a.checkLimits=function(){if(a.index<0)a.index=0;if(a.index>a.listLength)a.index=a.listLength;a.highlight()};a.highlight=function(c){if(a.index<0)a.index=a.options.wrap?a.listLength:0;if(a.index>a.listLength)a.index=a.options.wrap?0:a.listLength;var b;b= a.index;a.$divs.removeClass(a.options.highlight).eq(b).addClass(a.options.highlight).end().removeClass("faded1 faded2 faded3 faded4 faded5").filter(":gt("+(b+4)+"),:lt("+(b-4)+")").addClass("faded5").end().filter(":eq("+(b+4)+")"+(b-4<0?"":",:eq("+(b-4)+")")).addClass("faded4").end().filter(":eq("+(b+3)+")"+(b-3<0?"":",:eq("+(b-3)+")")).addClass("faded3").end().filter(":eq("+(b+2)+")"+(b-2<0?"":",:eq("+(b-2)+")")).addClass("faded2").end().filter(":eq("+(b+1)+")"+(b-1<0?"":",:eq("+(b-1)+")")).addClass("faded1"); c!==!0&&a.el.focus();b=a.$box.find("."+a.options.highlight);c=a.$box.position().top;b=a.$viewport.height()/2-b.position().top-b.outerHeight()/2;Math.abs(b-c)<5||a.$box.stop(!0,!0).animate({top:b},{queue:!1,duration:a.options.time,easing:a.options.easing})};a.setSelection=function(c,b){if(typeof c==="undefined"||isNaN(c))c=a.index;c<0&&(c=0);if(c>a.listLength)c=a.listLength;!a.options.multiple&&a.options.max===1&&a.$box.find("."+a.options.selected).length===1&&!a.$divs.eq(c).is(".disabled")&&a.$box.find("."+ a.options.selected).removeClass(a.options.selected);if(!(a.options.max!==!1&&a.$box.find("."+a.options.selected).length>=a.options.max&&!a.$divs.eq(c).is("."+a.options.selected)))a.$divs.eq(c).filter(":not(.disabled)").toggleClass(a.options.selected,b),a.el.options[c].selected=a.$divs.eq(a.index).is("."+a.options.selected)?!0:!1,a.initialized&&a.$el.trigger("changed.fancyselector",a)};a.getSelections=function(c,b){var d=a.$divs.filter("."+a.options.selected),e=a.$divs.filter("."+a.options.highlight), f=d.length;a.options.includeHighlight&&(f===0&&(d=e),a.options.max!==!1&&f<a.options.max&&d.filter("."+a.options.highlight).length===0&&(d=d.add(e[0])));if(typeof c==="undefined"||c===null)c=a.options.report;a.el.selectedIndex=-1;a.selectedOptions=d.map(function(){var b=a.$divs.index(this);a.el.options[b].selected=!0;return a.$returnedOptions[c](a,b)}).get();a.initialized&&b&&a.$el.trigger("submitted.fancyselector",[a,a.selectedOptions]);return a.selectedOptions};a.selectAll=function(){var c;if(a.options.multiple&& (a.options.max===!1||a.listLength<=a.options.max)){a.$divs.not(".disabled").addClass(a.options.selected);for(c=0;c<a.listLength;c++)a.el.options[c].selected=a.el.options[c].disabled?!1:!0;a.options.resizable&&a.highlight();a.initialized&&a.$el.trigger("changed.fancyselector",a)}};a.unselectAll=function(){a.$divs.not(".disabled").removeClass(a.options.selected);a.el.selectedIndex=-1;a.options.resizable&&a.highlight();a.initialized&&a.$el.trigger("changed.fancyselector",a)};a.destroy=function(){a.$box.remove(); var c={size:a.originalSize};if(a.originalMultiple!==!1&&typeof a.originalMultiple!=="undefined")c.multiple=!0;a.$el.removeClass("fancyselectorselect").attr(c).removeAttr("aria-hidden").removeAttr("role").unbind("keydown.fancyselector keypress.fancyselector focus.fancyselector blur.fancyselector mousewheel.fancyselector initialized.fancyselector changed.fancyselector submitted.fancyselector focused.fancyselector blurred.fancyselector").removeData("fancySelector").unwrap().nextAll(".fancySelector").remove()}; a.init()};d.fancySelector.defaultOptions={start:0,page:5,wrap:!0,time:500,easing:"swing",resizable:!1,expand:!1,includeHighlight:!0,multiple:!0,keepInView:!0,max:!1,report:"text",selected:"selected",highlight:"highlight",initialized:null,focused:null,changed:null,submitted:null,blurred:null};d.fancySelector.returnedOptions={text:function(d,f){return d.el.options[f].innerHTML},value:function(d,f){return d.el.options[f].value},index:function(d,f){return f},"class":function(d,f){return d.$options.eq(f).attr("class")}}; d.fn.fancySelector=function(e){return this.each(function(){new d.fancySelector(this,e)})};d.fn.getfancySelector=function(){return this.data("FancySelector")}})(jQuery);
